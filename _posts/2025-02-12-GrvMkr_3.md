---
title:  "GrvMkr: Triplets"
categories: projects
tags: web software percussion drumming samba
---

# TLDR
Added support for triplets and other non standard beat divisions to [GrvMkr](https://oliverdelange.co.uk/grvmkr/). It was kinda painful. 

![GrvMkr 9 days in]({{ site.url }}/assets/images/grvmkr/grvmkr_v3.png)

## TSMD (Too short, more detail)
Another roughly 3 days has passed, and i'm about ready to put this project on pause. The past three days has been slightly painful, in that i've had to re-work the domain layer of GrvMkr to make supporting triplets easier. 

### Merging grid cells
It started with a POC, to figure out how i can merge grid cells to accommodate irregular beat divisions. I couldn't be bothered to implement grid cell selection, so i went with a right click contextual menu UI. This is something i'd never implemented before but was relatively straightforward thankfully. 

Right clicking on a cell, gives the option to merge left or right. I added `cellsOccupied` in the UI layer to represent how many columns the cell spans in the grid. I used this to set the `grid-column` style directly on the grid cell `style="grid-column: span {ui.cellsOccupied}"`. This works nicely on the front end. 

The backend was slightly more tricky though. I'd made what i now know to be a bad design decision which was complicating the process of merging cells. 

I modeled the grid as an array of `GridRow`s which contains `Notation` which contained `Bar`s which contained `Beat`s which contained `BeatDivision`s. The clevererest among you will notice this deeply nested data structure isn't very smart. I didn't. 

When merging a cell, i had access to the cell which was right clicked - so i needed to find the one to the left or right. Easy right? Not really. With this deeply nested structure, its incredibly cumbersome to loop over each bar, beat, and division to find the adjecent cell, especially when in theory a cell may be merged between bars. That is, given a 2 bar phrase, if i wanted to merge the last beat division of bar 1 with the first division of bar 2. I asked chat gpt for help and it provided a bunch of super long, confusing function, which half worked. After about a day of not being satisfied with the outcome of this task, i was in the car and was wondering whether i should just remodel the entire structure to make it flatter, keep the grid modeled as a flat array of cells, and move the beat, bar, division logic to more of a view concern. Again i consulted chat gpt asking which approach is better, and it strongly favoured the flatter approach. 

It was a sad task to undo the last days work, but when it was done the benefits were clear. Getting the adjacent cell is now a simple case of looping either forwards (right) or backwards (left) through a 1 dimensional array from the clicked cell, finding the first cell with a `cellsOccupied` value > 1. Easy. 


### Playing audio out of time
After i'd sorted out the structure of the merged cells, i gave them an array of hits instead of one, to enable triplets etc. Now i needed to figure out how to play them. 

The current strategy of playing audio is incredibly basic, and i'm honestly suprised it works so well. I'm simply calculating the number of ms between each grid cell, and using `setInterval`, scheduling a function to run which plays any hits from the active grid column. 

I decided to run with this strategy since it was working so well, and extend it to support multiple hits in a cell. 
I first ignored any cell with `cellsOccupied < 1`, as these are merged cells and are not visible, and should not be playable. 
Then, i tried a simple approach of scheduling the merged cell hits using `setTimeout`  in a loop. 

I needed to calculate the delay first, which is a relatively straightforward percentage of the overall cell time. Say we're looking at a 2 cell merge, and we're operating at 60bpm, so every beat is 1000ms. Every beat is divided into 4 divisions, or cells, making each cell worth 250ms. 2 of these cells make 500ms. This is `mergedCellTime` below. 

Then to calculate the delay, we divide the index of the hit by the number of hits to get a value which is the percentage through the `mergedCellTime` the sample should play at. Multiply this by `mergedCellTime` to get the delay. This equally spaces the sample playback within the `mergedCellTime`. 

```ts
let mergedCellTime = currentlyPlayingGrid.msPerBeatDivision * cell.cells_occupied;
                
cell.hits.forEach((hit, i) => {
    let delay = (i / cell.hits.length) * mergedCellTime;
    setTimeout(() => {
        this.instrumentManager.playHit(hit);
    }, delay);
});
```

Honestly, musically i'm not entirely sure if this is correct. Looking at sample grid notation from my mum, the spacing isn't super clear on where the first hit should play. However, after reproducing a samba groove i know well from my days in a samba band, it sounded.... close enough. So i left it until i can get a more musical opinion. 


## Grid cell selection
Earlier, i mentioned i couldn't be bothered to implement cell selection. Well, with the ability to merge up to 8 cells, and an instrument having not limit on the number of hits, this meant the number of options in the right click context menu would be huge.

There's probably a better way to allow users to input off time hits, but i went with 'show em all the options' as seen below. 

![GrvMkr Cell Tools]({{ site.url }}/assets/images/grvmkr/grvmkr_v3_cell_tools.png)

## Samba instruments
I also spent some time finding some decent samba drum samples, and making them available by default along with the kick, snare and hat samples. This saves users rooting around the internet trying to do the same, because they're actually quite hard to come by apparently. 


# Final thoughts
Aside from some slightly more thorough testing, and bug fixing there's two things i want to do before i put this project to rest for a while. 

1. Copy Paste
   In samba, instruments play the same thing a lot of the time. Breaks are often a lot of unison. Manually inputting the same thing for 7 or 8 rows is tedious and time consuming. Ideally you'd be able to copy a row to another, or multiselect some cells and paste them. It'd be fun to implement some keyboard shortcuts too, thats something i've never done. 
2. State refactoring
   I'm not proud of the codebase currently. Its mostly alright, but the `app_state.svelte.ts` is a crime against code. Its a 700 line monstrosity that evolved from me not really caring about the architecture because this was 'only a small project' and 'would be done soon'. I'd love to spend some time trying to decouple areas like playback, grid management, instrument management, etc. I think i used the fact that i'm not a JS/TS guy as an excuse to 'just throw something together' and get something working. Hey its only a personal project right? True, but it could be a valuable learning experience for state management patterns in other languages. Maybe i'll finally look into clean architecture ðŸ™ˆ
3. Ok there's a third thing i guess. The dark grey backgrounds for columns that fall on the beat look weird when the cell is merged. I spent some time trying to figure out how best to tackle this, but i wasn't really happy with any approached that chat cpt suggested. I'll leave it for now, but may revisit. 